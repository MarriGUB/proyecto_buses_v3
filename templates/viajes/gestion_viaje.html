{% extends 'base.html' %}

{% block title %}Gestión de Viaje - Sistema de Gestión de Flota{% endblock %}

{% block extra_css %}
<style>
    .gestion-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 0;
    }
    .gestion-header {
        background-color: white;
        border-bottom: 2px solid #e9ecef;
        padding: 1.5rem;
    }
    .gestion-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 0;
    }
    .gestion-tabs .nav-link {
        color: #6c757d;
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 500;
    }
    .gestion-tabs .nav-link.active {
        color: #2196F3;
        background-color: white;
        border: none;
        border-bottom: 3px solid #2196F3;
    }
    .gestion-tabs .nav-link:hover {
        border: none;
        color: #2196F3;
    }
    .gestion-content {
        background-color: white;
        padding: 2rem;
    }
    .section-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    .section-title i {
        margin-right: 0.5rem;
        color: #2196F3;
    }
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 0.6rem 0.75rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: #2196F3;
        box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
    }
    .btn-gestion {
        border-radius: 4px;
        padding: 0.6rem 1.5rem;
        font-weight: 500;
    }
    .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        color: #6c757d;
    }
    .border-column {
        border-right: 2px solid #e9ecef;
    }
    .costo-total {
        background-color: #e8f5e8;
        border: 2px solid #27ae60;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    .resumen-costos {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .peaje-item {
        border-left: 4px solid #ffc107;
        background: #fffbf0;
    }
    .zona-peaje {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    @media (max-width: 991px) {
        .border-column {
            border-right: none;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="gestion-container">
    <!-- Header -->
    <div class="gestion-header">
        <h2 class="text-primary mb-0">Mockup 3: Gestión de Viaje (ID: {{ viaje.id }} | {{ viaje.lugar_origen.nombre }} -> {{ viaje.lugar_destino.nombre }})</h2>
    </div>

    <!-- Pestañas -->
    <ul class="nav gestion-tabs" id="viajeTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button" role="tab">
                <i class="fas fa-calculator me-2"></i> Gesti&oacute;n y Costos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="itinerario-tab" data-bs-toggle="tab" data-bs-target="#itinerario" type="button" role="tab">
                <i class="fas fa-route me-2"></i> Itinerario / Paradas
            </button>
        </li>
    </ul>

    <!-- Contenido de Pestañas -->
    <div class="tab-content" id="viajeTabContent">
        <!-- Pestaña Gestión y Costos -->
        <div class="tab-pane fade show active" id="gestion" role="tabpanel">
            <div class="gestion-content">
                <div class="row">
                    <!-- Columna Izquierda: Gestión y Costos -->
                    <div class="col-lg-6 border-column pe-lg-4">
                        <h5 class="section-title">
                            <i class="fas fa-info-circle me-2"></i> Datos del Viaje
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label">Bus Asignado</label>
                            <select class="form-select">
                                <option selected>{{ viaje.bus.placa }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Conductor Asignado</label>
                            <select class="form-select">
                                <option selected>{{ viaje.conductor.nombre }} {{ viaje.conductor.apellido }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Origen (Lugar)</label>
                            <select class="form-select">
                                <option selected>{{ viaje.lugar_origen.nombre }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destino (Lugar)</label>
                            <select class="form-select">
                                <option selected>{{ viaje.lugar_destino.nombre }}</option>
                            </select>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha Salida</label>
                                <input type="datetime-local" class="form-control" value="{{ viaje.fecha_salida|date:'Y-m-d\TH:i' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fecha Llegada Estimada</label>
                                <input type="datetime-local" class="form-control" value="{{ viaje.fecha_llegada_estimada|date:'Y-m-d\TH:i' }}">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Kilometraje Inicial</label>
                                <input type="number" class="form-control" value="150200">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kilometraje Final</label>
                                <input type="number" class="form-control" value="150225">
                            </div>
                        </div>

                        <button class="btn btn-primary btn-gestion">
                            <i class="fas fa-save me-2"></i>Actualizar Viaje
                        </button>

                        <hr class="my-4">

                        <h5 class="section-title">
                            <i class="fas fa-dollar-sign me-2"></i> Costos Principales del Viaje
                        </h5>
                        
                        <!-- Resumen de Costos -->
                        <div class="resumen-costos">
                            <h6 class="mb-3">Resumen de Costos Principales</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Combustible:</small>
                                    <div class="fw-bold">${{ costos_viaje.combustible|default:0 }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Mantenimiento:</small>
                                    <div class="fw-bold">${{ costos_viaje.mantenimiento|default:0 }}</div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">Otros Costos:</small>
                                    <div class="fw-bold">${{ costos_viaje.otros_costos|default:0 }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Total Costos:</small>
                                    <div class="fw-bold">${{ costos_viaje.combustible|add:costos_viaje.mantenimiento|add:costos_viaje.otros_costos|default:0 }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario para actualizar costos principales -->
                        <form method="post" action="{% url 'viajes:gestion_viaje' viaje.pk %}">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="actualizar_costos">
                            
                            <div class="mb-3">
                                <label class="form-label">Costo Combustible</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" name="combustible" class="form-control" value="{{ costos_viaje.combustible|default:0 }}" step="0.01" min="0" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Costo Mantenimiento</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" name="mantenimiento" class="form-control" value="{{ costos_viaje.mantenimiento|default:0 }}" step="0.01" min="0" required>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Otros Costos</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" name="otros_costos" class="form-control" value="{{ costos_viaje.otros_costos|default:0 }}" step="0.01" min="0" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success btn-gestion w-100">
                                <i class="fas fa-check-circle me-2"></i>Confirmar Costos Principales
                            </button>
                        </form>
                    </div>

                    <!-- Columna Derecha: Peajes -->
                    <div class="col-lg-6 ps-lg-4">
                        <h5 class="section-title">
                            <i class="fas fa-road me-2"></i> Gestión de Peajes por Zonas
                        </h5>
                        
                        <!-- Formulario para añadir peaje por zona -->
                        <form method="post" action="{% url 'viajes:gestion_viaje' viaje.pk %}">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="agregar_peaje">
                            
                            <div class="mb-3">
                                <label class="form-label">Zona del Peaje</label>
                                <select name="zona_peaje" class="form-select" required>
                                    <option value="">Seleccione una zona...</option>
                                    <option value="Zona Norte">Zona Norte</option>
                                    <option value="Zona Centro">Zona Centro</option>
                                    <option value="Zona Sur">Zona Sur</option>
                                    <option value="Zona Metropolitana">Zona Metropolitana</option>
                                    <option value="Zona Costera">Zona Costera</option>
                                    <option value="Zona Montañosa">Zona Montañosa</option>
                                    <option value="otro">Otra Zona</option>
                                </select>
                            </div>

                            <div class="mb-3" id="otra-zona-container" style="display: none;">
                                <label class="form-label">Especifique la Zona</label>
                                <input type="text" name="otra_zona" class="form-control" placeholder="Nombre de la zona...">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nombre del Peaje</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-road"></i></span>
                                    <input type="text" name="lugar_peaje" class="form-control" placeholder="Ej: Peaje Ruta 5 Sur" required>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Costo del Peaje</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" name="monto_peaje" class="form-control" value="0" step="0.01" min="0" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-warning btn-gestion w-100 mb-4">
                                <i class="fas fa-plus me-2"></i>Registrar Peaje Estimado
                            </button>
                        </form>

                        <!-- Lista de Peajes por Zonas -->
                        <h6 class="mt-4 mb-3">Peajes Registrados por Zona</h6>
                        
                        {% if viaje.peajes.all %}
                            <!-- Agrupar peajes por zona -->
                            {% regroup viaje.peajes.all by lugar as peajes_por_zona %}
                            
                            {% for zona in peajes_por_zona %}
                            <div class="zona-peaje mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="text-primary">{{ zona.grouper }}</strong>
                                    <span class="badge bg-warning text-dark">
                                        {{ zona.list|length }} peaje{{ zona.list|length|pluralize }}
                                    </span>
                                </div>
                                
                                {% for peaje in zona.list %}
                                <div class="peaje-item border rounded p-2 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted d-block">{{ peaje.lugar }}</small>
                                            <strong>${{ peaje.monto }}</strong>
                                        </div>
                                        <div>
                                            <form method="post" action="{% url 'viajes:gestion_viaje' viaje.pk %}" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="accion" value="eliminar_peaje">
                                                <input type="hidden" name="peaje_id" value="{{ peaje.id }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Está seguro de eliminar este peaje?')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                <!-- Subtotal por zona -->
                                <div class="text-end">
                                    <small class="text-muted">
                                        Subtotal {{ zona.grouper }}: 
                                        <strong>${% widthratio zona.list|length 1 peaje.monto %}</strong>
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No hay peajes registrados para este viaje.
                            </div>
                        {% endif %}

                        <!-- Resumen Total de Peajes -->
                        <div class="border-top pt-3 mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total en Peajes:</strong>
                                <strong class="text-primary fs-5">${{ costos_viaje.peajes|default:0 }}</strong>
                            </div>
                            <div class="text-end mt-2">
                                <small class="text-muted">
                                    {{ viaje.peajes.count }} peaje{{ viaje.peajes.count|pluralize }} registrado{{ viaje.peajes.count|pluralize }}
                                </small>
                            </div>
                        </div>

                        <!-- Costo Total General -->
                        <div class="costo-total mt-4">
                            <div class="row">
                                <div class="col-8">
                                    <strong class="text-success">COSTO TOTAL DEL VIAJE:</strong>
                                </div>
                                <div class="col-4 text-end">
                                    <strong class="text-success fs-5">
                                        ${% widthratio costos_viaje.costo_total 1 1 %}
                                    </strong>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">
                                        Costos Principales: ${{ costos_viaje.combustible|add:costos_viaje.mantenimiento|add:costos_viaje.otros_costos|default:0 }} 
                                        + Peajes: ${{ costos_viaje.peajes|default:0 }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña Itinerario/Paradas -->
        <div class="tab-pane fade" id="itinerario" role="tabpanel">
            <div class="gestion-content">
                <div class="row">
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-route fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">Itinerario / Paradas</h4>
                            <p class="text-muted">Esta funcionalidad estará disponible próximamente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{% url 'viajes:viaje_detail' viaje.pk %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver al Detalle del Viaje
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar/ocultar campo para otra zona
    const zonaSelect = document.querySelector('select[name="zona_peaje"]');
    const otraZonaContainer = document.getElementById('otra-zona-container');
    
    zonaSelect.addEventListener('change', function() {
        if (this.value === 'otro') {
            otraZonaContainer.style.display = 'block';
        } else {
            otraZonaContainer.style.display = 'none';
        }
    });
});
</script>
{% endblock %}