{% extends 'base.html' %}

{% block title %}{% if viaje %}Editar Viaje{% else %}Crear Viaje{% endif %} - Sistema de Gestión de Flota{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-{% if viaje %}edit{% else %}plus{% endif %} me-2"></i>
                {% if viaje %}Editar Viaje{% else %}Crear Nuevo Viaje{% endif %}
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            <strong>Errores en el formulario:</strong>
                            <ul class="mb-0">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- SECCIÓN DATOS DEL VIAJE -->
                    <h5 class="section-title mb-3">
                        <i class="fas fa-info-circle me-2"></i>Datos del Viaje
                    </h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.bus.id_for_label }}" class="form-label">
                                <i class="fas fa-bus me-2"></i>Bus <span class="text-danger">*</span>
                            </label>
                            {{ form.bus }}
                            {% if form.bus.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.bus.errors|first }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.conductor.id_for_label }}" class="form-label">
                                <i class="fas fa-user me-2"></i>Conductor <span class="text-danger">*</span>
                            </label>
                            {{ form.conductor }}
                            {% if form.conductor.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.conductor.errors|first }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.lugar_origen.id_for_label }}" class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Lugar de Origen <span class="text-danger">*</span>
                            </label>
                            {{ form.lugar_origen }}
                            {% if form.lugar_origen.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.lugar_origen.errors|first }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.lugar_destino.id_for_label }}" class="form-label">
                                <i class="fas fa-map-pin me-2"></i>Lugar de Destino <span class="text-danger">*</span>
                            </label>
                            {{ form.lugar_destino }}
                            {% if form.lugar_destino.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.lugar_destino.errors|first }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_salida.id_for_label }}" class="form-label">
                                <i class="fas fa-clock me-2"></i>Fecha y Hora de Salida <span class="text-danger">*</span>
                            </label>
                            {{ form.fecha_salida }}
                            {% if form.fecha_salida.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.fecha_salida.errors|first }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_llegada_estimada.id_for_label }}" class="form-label">
                                <i class="fas fa-hourglass-end me-2"></i>Fecha y Hora Est. de Llegada <span class="text-danger">*</span>
                            </label>
                            {{ form.fecha_llegada_estimada }}
                            {% if form.fecha_llegada_estimada.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.fecha_llegada_estimada.errors|first }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_llegada_real.id_for_label }}" class="form-label">
                                <i class="fas fa-check-circle me-2"></i>Fecha y Hora Real de Llegada (Opcional)
                            </label>
                            {{ form.fecha_llegada_real }}
                            {% if form.fecha_llegada_real.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.fecha_llegada_real.errors|first }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.estado.id_for_label }}" class="form-label">
                                <i class="fas fa-tasks me-2"></i>Estado <span class="text-danger">*</span>
                            </label>
                            {{ form.estado }}
                            {% if form.estado.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.estado.errors|first }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                            <i class="fas fa-sticky-note me-2"></i>Observaciones (Opcional)
                        </label>
                        {{ form.observaciones }}
                        {% if form.observaciones.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.observaciones.errors|first }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- NUEVA SECCIÓN: COSTOS ESTIMADOS DEL VIAJE -->
                    <hr class="my-4">
                    <h5 class="section-title mb-3">
                        <i class="fas fa-dollar-sign me-2"></i>Costos Estimados del Viaje
                    </h5>

                    <!-- Lista de Costos Ingresados (se llenará con JavaScript) -->
                    <div class="mb-4">
                        <h6 class="mb-3">Costos Registrados</h6>
                        <div id="lista-costos" class="border rounded p-3 bg-light" style="min-height: 100px;">
                            <div class="text-muted text-center py-3" id="mensaje-vacio">
                                <i class="fas fa-receipt fa-2x mb-2"></i><br>
                                No hay costos registrados aún
                            </div>
                            <!-- Aquí se agregarán los costos dinámicamente -->
                        </div>
                    </div>

                    <!-- Formulario para agregar costos -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-plus me-2"></i>Agregar Costo Estimado</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tipo de Costo</label>
                                    <select class="form-select" id="tipo-costo">
                                        <option value="combustible">Combustible</option>
                                        <option value="mantenimiento">Mantenimiento</option>
                                        <option value="peajes">Peajes</option>

                                        <option value="otros">Otros Costos</option>
                                    </select>
                                </div>

                                <div class="col-md-5 mb-3">
                                    <label class="form-label">Descripción</label>
                                    <input type="text" class="form-control" id="descripcion-costo" placeholder="Ej: Combustible estimado ida y vuelta">
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Monto Estimado</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="monto-costo" step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-success w-100" onclick="agregarCosto()">
                                <i class="fas fa-plus-circle me-2"></i>Agregar a la Lista
                            </button>
                        </div>
                    </div>

                    <!-- Campos ocultos para enviar los costos al servidor -->
                    <div id="costos-ocultos">
                        <!-- Se llenará con JavaScript -->
                    </div>

                    <!-- Resumen de Costos -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Estimado:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <strong id="total-costos">$0.00</strong>
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Los costos se pueden ajustar posteriormente en la gestión del viaje.
                        </small>
                    </div>

                    <div class="d-flex gap-2 justify-content-between mt-4">
                        <a href="{% url 'viajes:viaje_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>{% if viaje %}Guardar Cambios{% else %}Crear Viaje{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.section-title {
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}
.costo-item {
    background: white;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid #2196F3;
}
.costo-item.eliminado {
    opacity: 0.6;
    text-decoration: line-through;
    border-left-color: #dc3545;
}
</style>

<script>
let costosRegistrados = [];

function agregarCosto() {
    const tipo = document.getElementById('tipo-costo').value;
    const descripcion = document.getElementById('descripcion-costo').value;
    const monto = parseFloat(document.getElementById('monto-costo').value);

    if (!descripcion || !monto || monto <= 0) {
        alert('Por favor, complete la descripción y un monto válido');
        return;
    }

    const costo = {
        id: Date.now(), // ID único
        tipo: tipo,
        descripcion: descripcion,
        monto: monto
    };

    costosRegistrados.push(costo);
    actualizarListaCostos();
    actualizarCamposOcultos();
    actualizarTotal();

    // Limpiar formulario
    document.getElementById('descripcion-costo').value = '';
    document.getElementById('monto-costo').value = '';
}

function eliminarCosto(id) {
    costosRegistrados = costosRegistrados.filter(costo => costo.id !== id);
    actualizarListaCostos();
    actualizarCamposOcultos();
    actualizarTotal();
}

function actualizarListaCostos() {
    const lista = document.getElementById('lista-costos');
    
    if (costosRegistrados.length === 0) {
        lista.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-receipt fa-2x mb-2"></i><br>
                No hay costos registrados aún
            </div>
        `;
        return;
    }
    
    let html = '';
    costosRegistrados.forEach(costo => {
        // Colores diferentes por tipo de costo
        let colorBorde = '#2196F3'; // Azul por defecto
        if (costo.tipo === 'combustible') colorBorde = '#ff9800'; // Naranja
        if (costo.tipo === 'mantenimiento') colorBorde = '#4caf50'; // Verde
        if (costo.tipo === 'peajes') colorBorde = '#ffc107'; // Amarillo
        if (costo.tipo === 'otros') colorBorde = '#9c27b0'; // Morado
        
        html += `
            <div class="costo-item" style="border-left-color: ${colorBorde}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-capitalize">${costo.tipo}</strong>
                        <div class="text-muted small">${costo.descripcion}</div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-bold">$${costo.monto.toFixed(2)}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarCosto(${costo.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    lista.innerHTML = html;
}

function actualizarCamposOcultos() {
    const container = document.getElementById('costos-ocultos');
    container.innerHTML = '';

    costosRegistrados.forEach((costo, index) => {
        container.innerHTML += `
            <input type="hidden" name="costos[${index}][tipo]" value="${costo.tipo}">
            <input type="hidden" name="costos[${index}][descripcion]" value="${costo.descripcion}">
            <input type="hidden" name="costos[${index}][monto]" value="${costo.monto}">
        `;
    });
}

function actualizarTotal() {
    const total = costosRegistrados.reduce((sum, costo) => sum + costo.monto, 0);
    document.getElementById('total-costos').textContent = `$${total.toFixed(2)}`;
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    actualizarListaCostos();
});
</script>
{% endblock %}